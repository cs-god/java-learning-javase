
src.java.catalina.startup.Bootstrap

	Bootstrap loader for Catalina.  This application constructs a class loader  
	for use in loading the Catalina internal classes (by accumulating all of the  
	JAR files found in the "server" directory under "catalina.home"), and  
	starts the regular execution of the container.  The purpose of this  
	roundabout approach is to keep the Catalina internal classes (and any  
	other classes they depend on, such as an XML parser) out of the system  
	class path and therefore not visible to application level classes.

# 属性

```java

```


# 静态代码块

1）往系统类（System）的属性(Property)中设置  Constants.CATALINA_HOME_PROP（即catalina.home）属性

- 检查系统类中是否有 catalina.home 属性，如果有就用它来创建 File 对象。
- 检查系统类的 user.dir 下是否有 bootstrap.jar 文件，如果有就用 user.dir 的上一级目录创建 File 对象后获得。
- 用 user.dir 的路径来创建 File 对象。

2）往系统类（System）的属性(Property)中设置  Constants.CATALINA_BASE_PROP （即catalina.base）属性

如果系统类（System）中没有catalina.base属性，就用 catalina.home 


```java
String userDir = System.getProperty("user.dir");  // Home first  
// Constants.CATALINA_HOME_PROP = "catalina.home"
String home = System.getProperty(Constants.CATALINA_HOME_PROP);
File homeFile = null;
if (home != null) {
    File f = new File(home);  
    try {
        homeFile = f.getCanonicalFile();
    } catch (IOException ioe) {  
        homeFile = f.getAbsoluteFile();  
    }  
}
if (homeFile == null) {  
    // First fall-back.
    // See if current directory is a bin directory in a normal Tomcat install.
    File bootstrapJar = new File(userDir, "bootstrap.jar");
    if (bootstrapJar.exists()) {
	    File f = new File(userDir, "..");  
	    try {
	        homeFile = f.getCanonicalFile();  
	    } catch (IOException ioe) {  
	        homeFile = f.getAbsoluteFile();  
	    }
    }
}
if (homeFile == null) {  
    // Second fall-back. Use current directory  
    File f = new File(userDir);  
    try {  
        homeFile = f.getCanonicalFile();  
    } catch (IOException ioe) {  
        homeFile = f.getAbsoluteFile();  
    }  
}
catalinaHomeFile = homeFile;  
System.setProperty(Constants.CATALINA_HOME_PROP, catalinaHomeFile.getPath());  
// Then base
String base = System.getProperty(Constants.CATALINA_BASE_PROP);  // CATALINA_BASE_PROP = "catalina.base"
if (base == null) {  
    catalinaBaseFile = catalinaHomeFile;  
} else {
    File baseFile = new File(base);  
    try {  
        baseFile = baseFile.getCanonicalFile();  
    } catch (IOException ioe) {  
        baseFile = baseFile.getAbsoluteFile();  
    }  
    catalinaBaseFile = baseFile;
}
System.setProperty(Constants.CATALINA_BASE_PROP, catalinaBaseFile.getPath());
```

# 主函数

```java
// static volatile Bootstrap daemon = null;
public static void main(String args[]) {  
    synchronized (daemonLock) {
        if (daemon == null) {  
            // Don't set daemon until init() has completed  
            Bootstrap bootstrap = new Bootstrap();  
            try {
                bootstrap.init();  
            } catch (Throwable t) {  
                handleThrowable(t);  
                t.printStackTrace();  
                return;            }  
            daemon = bootstrap;  
        } else {  
            // When running as a service the call to stop will be on a new  
            // thread so make sure the correct class loader is used to            // prevent a range of class not found exceptions.
            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);  
        }  
    }  
  
    try {  
        String command = "start";  
        if (args.length > 0) {  
            command = args[args.length - 1];  
        }  
  
        if (command.equals("startd")) {  
            args[args.length - 1] = "start";  
            daemon.load(args);  
            daemon.start();  
        } else if (command.equals("stopd")) {  
            args[args.length - 1] = "stop";  
            daemon.stop();  
        } else if (command.equals("start")) {  
            daemon.setAwait(true);  
            daemon.load(args);  
            daemon.start();  
            if (null == daemon.getServer()) {  
                System.exit(1);  
            }  
        } else if (command.equals("stop")) {  
            daemon.stopServer(args);  
        } else if (command.equals("configtest")) {  
            daemon.load(args);  
            if (null == daemon.getServer()) {  
                System.exit(1);  
            }  
            System.exit(0);  
        } else {  
            log.warn("Bootstrap: command \"" + command + "\" does not exist.");  
        }  
    } catch (Throwable t) {  
        // Unwrap the Exception for clearer error reporting  
        if (t instanceof InvocationTargetException &&  
                t.getCause() != null) {  
            t = t.getCause();  
        }  
        handleThrowable(t);  
        t.printStackTrace();  
        System.exit(1);  
    }  
}
```

# 初始化

```java
public void init() throws Exception {  
    initClassLoaders();  
    Thread.currentThread().setContextClassLoader(catalinaLoader);  
    SecurityClassLoad.securityClassLoad(catalinaLoader);  
  
    // Load our startup class and call its process() method  
    if (log.isDebugEnabled()) {  
        log.debug("Loading startup class");  
    }  
    Class<?> startupClass = catalinaLoader.loadClass("org.apache.catalina.startup.Catalina");  
    Object startupInstance = startupClass.getConstructor().newInstance();  
  
    // Set the shared extensions class loader  
    if (log.isDebugEnabled()) {  
        log.debug("Setting startup class properties");  
    }  
    String methodName = "setParentClassLoader";  
    Class<?> paramTypes[] = new Class[1];  
    paramTypes[0] = Class.forName("java.lang.ClassLoader");  
    Object paramValues[] = new Object[1];  
    paramValues[0] = sharedLoader;  
    Method method =  
        startupInstance.getClass().getMethod(methodName, paramTypes);  
    method.invoke(startupInstance, paramValues);  
  
    catalinaDaemon = startupInstance;  
}
```

## 初始化类加载器(initClassLoaders)

```java
commonLoader = createClassLoader("common", null);  
if (commonLoader == null) {  
    // no config file, default to this loader - we might be in a 'single' env.  
    commonLoader = this.getClass().getClassLoader();  
}  
catalinaLoader = createClassLoader("server", commonLoader);  
sharedLoader = createClassLoader("shared", commonLoader);  
}
```

### 试图去创建自定义类加载器(createClassLoader)

```java
// private ClassLoader createClassLoader(String name, ClassLoader parent)
String value = CatalinaProperties.getProperty(name + ".loader");  
if ((value == null) || (value.equals(""))) {  
    return parent;  
}  
value = replace(value);  

List<Repository> repositories = new ArrayList<>();  
for (String repository : getPaths(value)) {  
    // Check for a JAR URL repository  
    URL url = new URL(repository);  
    repositories.add(new Repository(repository, RepositoryType.URL));  
    continue;
    }  
    // Local repository  
    if (repository.endsWith("*.jar")) {  
        repository = repository.substring  
            (0, repository.length() - "*.jar".length());  
        repositories.add(new Repository(repository, RepositoryType.GLOB));  
    } else if (repository.endsWith(".jar")) {  
        repositories.add(new Repository(repository, RepositoryType.JAR));  
    } else {  
        repositories.add(new Repository(repository, RepositoryType.DIR));  
    }  
}  
  
return ClassLoaderFactory.createClassLoader(repositories, parent);
```

# 工具方法

## 解析  ${  } 符号

```java
// protected String replace(String str)
String result = str;  
int pos_start = str.indexOf("${");  
if (pos_start >= 0) {  
    StringBuilder builder = new StringBuilder();  
    int pos_end = -1;
    while (pos_start >= 0) {
        builder.append(str, pos_end + 1, pos_start);  
        pos_end = str.indexOf('}', pos_start + 2);  
        if (pos_end < 0) {
            pos_end = pos_start - 1;  
            break;
        }  
        String propName = str.substring(pos_start + 2, pos_end);  
        String replacement;  
        if (propName.length() == 0) {  
            replacement = null;  
        } else if (Constants.CATALINA_HOME_PROP.equals(propName)) {  
            replacement = getCatalinaHome();  
        } else if (Constants.CATALINA_BASE_PROP.equals(propName)) {  
            replacement = getCatalinaBase();  
        } else {  
            replacement = System.getProperty(propName);  
        }  
        if (replacement != null) {  
            builder.append(replacement);  
        } else {  
            builder.append(str, pos_start, pos_end + 1);  
        }  
        pos_start = str.indexOf("${", pos_end + 1);  
    }  
    builder.append(str, pos_end + 1, str.length());  
    result = builder.toString();  
}  
return result;
```

## 匹配正则路径

```java
// protected static String[] getPaths(String value)
List<String> result = new ArrayList<>();  
Matcher matcher = PATH_PATTERN.matcher(value); // PATH_PATTERN = (\"[^\"]*\")|(([^,])*)
while (matcher.find()) {  
    String path = value.substring(matcher.start(), matcher.end());  
    path = path.trim();  
    if (path.length() == 0) {  
        continue;  
    }  
    char first = path.charAt(0);  
    char last = path.charAt(path.length() - 1);  
    if (first == '"' && last == '"' && path.length() > 1) {  
        path = path.substring(1, path.length() - 1);  
        path = path.trim();  
        if (path.length() == 0) {  
            continue;  
        }  
    } else if (path.contains("\"")) {  
        // Unbalanced quotes  
        // Too early to use standard i18n support. The class path hasn't        // been configured.        throw new IllegalArgumentException(  
                "The double quote [\"] character can only be used to quote paths. It must " +  
                "not appear in a path. This loader path is not valid: [" + value + "]");  
    } else {  
        // Not quoted - NO-OP  
    }  
    result.add(path);  
}  
return result.toArray(new String[0]);
```

```properties
common.loader="${catalina.base}/lib","${catalina.base}/lib/*.jar","${catalina.home}/lib","${catalina.home}/lib/*.jar"
server.loader=
shared.loader=
```
