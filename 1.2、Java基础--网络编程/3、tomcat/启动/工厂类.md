

```java
// public static ClassLoader createClassLoader(List<Repository> repositories, final ClassLoader parent)
Set<URL> set = new LinkedHashSet<>();

if (repositories != null) {  
    for (Repository repository : repositories)  {  
        if (repository.getType() == RepositoryType.URL) {  
            URL url = buildClassLoaderUrl(repository.getLocation());  
            set.add(url);  
        } else if (repository.getType() == RepositoryType.DIR) {  
            File directory = new File(repository.getLocation());  
            directory = directory.getCanonicalFile();  
            if (!validateFile(directory, RepositoryType.DIR)) {  
                continue;  
            }  
            URL url = buildClassLoaderUrl(directory);  
            set.add(url);  
        } else if (repository.getType() == RepositoryType.JAR) {  
            File file=new File(repository.getLocation());  
            file = file.getCanonicalFile();  
            if (!validateFile(file, RepositoryType.JAR)) {  
                continue;  
            }  
            URL url = buildClassLoaderUrl(file);  
            set.add(url);  
        } else if (repository.getType() == RepositoryType.GLOB) {  
            File directory=new File(repository.getLocation());  
            directory = directory.getCanonicalFile();  
            if (!validateFile(directory, RepositoryType.GLOB)) {  
                continue;  
            }  
            String filenames[] = directory.list();  
            if (filenames == null) {  
                continue;  
            }  
            for (String s : filenames) {  
                String filename = s.toLowerCase(Locale.ENGLISH);  
                if (!filename.endsWith(".jar")) {  
                    continue;  
                }  
                File file = new File(directory, s);  
                file = file.getCanonicalFile();  
                if (!validateFile(file, RepositoryType.JAR)) {  
                    continue;  
                }  
                URL url = buildClassLoaderUrl(file);  
                set.add(url);  
            }  
        }  
    }
}
// Construct the class loader itself  
final URL[] array = set.toArray(new URL[0]);  
return AccessController.doPrivileged(  
        (PrivilegedAction<URLClassLoader>) () -> {  
            if (parent == null) {  
                return new URLClassLoader(array);  
            } else {  
                return new URLClassLoader(array, parent);  
            }  
        });
```

# 工具方法

```java
// private static boolean validateFile(File file, RepositoryType type) throws IOException
if (RepositoryType.DIR == type || RepositoryType.GLOB == type) {  
    if (!file.isDirectory() || !file.canRead()) {  
        File home = new File (Bootstrap.getCatalinaHome());  
        home = home.getCanonicalFile();  
        File base = new File (Bootstrap.getCatalinaBase());  
        base = base.getCanonicalFile();  
        File defaultValue = new File(base, "lib");  
        return false;  
    }  
} else if (RepositoryType.JAR == type) {  
    if (!file.canRead()) {  
        return false;
    }  
}  
return true;
```