## Class类文件的结构

Class文件是一组以字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在文件之中，中间没有添加任何分隔符。当遇到需要占用单个字节以上空间的数据项时，则会按照高位在前的方式分割成若干字节进行存储。^[1]^ （大端存储）

为方便阅读下面的内容，需要预先了解一定的规则：

- 无符号数

  ​        属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节、8个字节的无符号数。无符号数可以用来描述数字、索引引用、数值量或者按照UTF-8编码构成字符串值。

- 表

  由多个无符号数或者其他表作为数据项构成的复合数据类型，为了便于区分，所有表的命名都习惯性地以"_info"结尾



### Class文件格式

|              类型              |                           名称                           |                      数量                      |
| :----------------------------: | :------------------------------------------------------: | :--------------------------------------------: |
|               u4               |                          magic                           |                       1                        |
|               u2               |                      minor_version                       |                       1                        |
|               u2               |                      major_version                       |                       1                        |
|   <font color=red>u2</font>    | <font color=red>constant_pool_count（常量池数量）</font> |            <font color=red>1</font>            |
| <font color=red>cp_info</font> |           <font color=red>constant_pool</font>           | <font color=red>constant_pool_count  -1</font> |
|               u2               |                       access_flag                        |                       1                        |
|               u2               |                        this_class                        |                       1                        |
|               u2               |                       super_class                        |                       1                        |
|               u2               |                     interfaces_count                     |                       1                        |
|               u2               |                        interfaces                        |                interfaces_count                |
|               u2               |                       fields_count                       |                       1                        |
|           field_info           |                          fields                          |                  fields_count                  |
|               u2               |                      methods_count                       |                       1                        |
|          method_info           |                         methods                          |                 methods_count                  |
|               u2               |                     attributes_count                     |                       1                        |
|         attribute_info         |                        attributes                        |                attributes_count                |



## 常量池

常量池主要存放两大类常量：**字面量**和**符号引用**

**字面量**：文本字符串、被声明为final的常量值等

**符号引用**：

​	被模块导出或者开放的**包**

​	**类和接口的全限定名**

​	**字段的名称和描述符**

​	**方法的名称和描述符**

​	方法句柄和方法类型

​	动态调用点和动态常量



截至JDK13，常量表中有**17**种不同类型的常量



### 常量池的项目类型

|          类型           | 标志 |        描述        |
| :---------------------: | :--: | :----------------: |
|   CONSTANT_Utf8_info    |  1   | UTF-8编码的字符串  |
|  CONSTANT_Integer_info  |  3   |     整型字面量     |
|   CONSTANT_Float_info   |  4   |    浮点型字面量    |
|   CONSTANT_Long_info    |  5   |    长整型字面量    |
|  CONSTANT_Double_info   |  6   | 双精度浮点型字面量 |
|   CONSTANT_Class_info   |  7   | 类或接口的符号引用 |
|  CONSTANT_String_info   |  8   |  字符串类型字面量  |
| CONSTANT_Fieldref_info  |  9   |   字段的符号引用   |
| CONSTANT_Methodref_info |  10  |   方法的符号引用   |
|        CONSTANT_        |  11  |                    |
|        CONSTANT_        |  12  |                    |
|        CONSTANT_        |  15  |                    |
|                         |  16  |                    |
|        CONSTANT_        |  17  |                    |
|                         |  18  |                    |
|                         |  19  |                    |
|                         |  20  |                    |

### CONSTANT_Utf8_info

使用utf-8缩略码对数据进行编码

| 类型 |  名称  |  数量  |
| :--: | :----: | :----: |
|  u1  |  tag   |   1    |
|  u2  | length |   1    |
|  u1  | bytes  | length |

### CONSTANT_Class_info

| 类型 |    名称    | 数量 |
| :--: | :--------: | :--: |
|  u1  |    tag     |  1   |
|  u2  | name_index |  1   |

### CONSTANT_Integer_info

`



## 访问标志

access_flags中一共有16个标志位可用，当前只定义了其中的9个，没有使用到的标志位要求一律为零。



![image-20220419061012715](D:\typora\pic\6 类文件结构\image-20220419061012715.png)

|    标志名称    | 含义 |
| :------------: | :--: |
|   ACC_PUBLIC   |      |
|   ACC_FINAL    |      |
|   ACC_SUPER    |      |
| ACC_INTERFACE  |      |
|  ACC_ABSTRACT  |      |
| ACC_SYNTHETIC  |      |
| ACC_ANNOTATION |      |
|    ACC_ENUM    |      |
|   ACC_MODULE   |      |



## 类索引、父类索引与接口索引集合

类索引(this_class)和父类索引(super_class)都是一个u2类型的数据，而接口索引集合是一组u2类型的数据的集合，Class文件由这三项数据来确定该类型的继承关系。

![image-20220419062224765](D:\typora\pic\6 类文件结构\image-20220419062224765.png)



## 字段表集合



## 属性表集合

#### 14、运行时注解相关属性

<font color=#0099ff>RuntimeVisibleAnnotations（Java5）</font>、<font color=#0099ff>RuntimeInvisibleAnnotations（Java5）</font>、<font color=#0099ff>RuntimeVisibleParameterAnnotations（Java5）</font>、<font color=#0099ff>RuntimeInvisibleParameterAnnotations（Java5）</font>、<font color=#0099ff>RuntimeVisibleTypeAnnotations（Java8）</font>、<font color=#0099ff>RuntimeInvisibleTypeAnnotations（Java8）</font>六大属性。

以上六个属性的结构和功能类似，以RuntimeVisibleAnnotations（Java5）为代表进行介绍。

RuntimeVisibleAnnotations属性结构如下。

|    类型    |         名称         |      数量      |
| :--------: | :------------------: | :------------: |
|     u2     | attribute_name_index |       1        |
|     u4     |   attribute_length   |       1        |
|     u2     |   num_annotations    |       1        |
| annotation |     annotations      | num_annotation |

- num_annotations：annotations数组的计数器，annotations中的每个元素都代表了一个运行时可见的注解，注解在Class文件中以annotation结构来存储。

annotation结构如下。

|        类型         |          名称           |          数量           |
| :-----------------: | :---------------------: | :---------------------: |
|         u2          |       type_index        |            1            |
|         u2          | num_element_value_pairs |            1            |
| element_value_pairs |   element_value_pair    | num_element_value_pairs |

- type_index：指向CONSTANT_Utf8_info常量的索引值，该常量以字段描述符的形式表示一个注解。
- num_element_value_pairs：element_value_pairs数组的计数器，表示一个注解中键值对的数量。
- element_value_pair：一个键值对，代表一个注解中的一个属性和该属性对应值的键值对。

